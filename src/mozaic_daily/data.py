# -*- coding: utf-8 -*-
"""BigQuery data fetching and query execution.

This module executes SQL queries against BigQuery and returns DataFrames.
Supports checkpoint-based caching to disk (parquet files) to avoid
re-querying during development/testing.

SQL queries are generated by QuerySpec.build_query() in queries.py.

Functions:
- get_queries(): Build SQL queries for all platform/metric combinations
- get_aggregate_data(): Fetch all Desktop and Mobile metrics from BigQuery
"""

from typing import Dict, Optional
import pandas as pd
from google.cloud import bigquery
import os
from .config import STATIC_CONFIG
from .queries import QUERY_SPECS, Platform, Metric


def get_queries(
    countries: str,
    testing_mode: bool = False
) -> Dict[str, Dict[str, str]]:
    """Build SQL queries for all platform/metric combinations."""
    queries = {"desktop": {}, "mobile": {}}

    for spec in QUERY_SPECS.values():
        queries[spec.platform.value][spec.metric.value] = spec.build_query(countries)

        if testing_mode and spec.platform == Platform.DESKTOP and spec.metric == Metric.DAU:
            return queries

    return queries

# Get data
def get_aggregate_data(
    queries: Dict[str, Dict[str, str]],
    project: str,
    checkpoints: Optional[bool] = False,
) -> Dict[str, Dict[str, pd.DataFrame]]:
    datasets = {"desktop": {}, "mobile": {}}

    # Use template from STATIC_CONFIG for checkpoint filenames
    filename_template = STATIC_CONFIG['raw_checkpoint_filename_template']

    # fetch query results and store the raw data
    for metric, query in queries["desktop"].items():
        checkpoint_filename = filename_template.format(platform="desktop", metric=metric)
        df = None
        if checkpoints and os.path.exists(checkpoint_filename):
            print(f'Desktop {metric} exists, loading')
            df = pd.read_parquet(checkpoint_filename)
        else:
            print(f"Querying Desktop {metric}")
            print (query)
            df = bigquery.Client(project).query(query).to_dataframe()
            if checkpoints:
                df.to_parquet(checkpoint_filename)
        datasets['desktop'][metric] = df

    for metric, query in queries["mobile"].items():
        checkpoint_filename = filename_template.format(platform="mobile", metric=metric)
        df = None
        if checkpoints and os.path.exists(checkpoint_filename):
            print(f'Mobile {metric} exists, loading')
            df = pd.read_parquet(checkpoint_filename)
        else:
            print(f"Querying Mobile {metric}")
            print(query)
            df = bigquery.Client(project).query(query).to_dataframe()
            if checkpoints:
                df.to_parquet(checkpoint_filename)
        datasets['mobile'][metric] = df

    return datasets
